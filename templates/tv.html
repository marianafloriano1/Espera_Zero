<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>PÃ³dio de Caixas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/estilotv.css') }}" />
</head>

<body>
  <div class="podio">
    <div class="col">
      <div class="titulo"></div>
      <!-- IMAGEM INDICADOR ACIMA DO TEMPO -->
      <img class="indicador-tempo" src="{{ url_for('static', filename='img/relogio2.png') }}" alt="Indicador de tempo" />
      <div class="tempo" id="tempo-normal">--</div>
      <div class="caixa" id="normal">
        <p class="texto">CAIXA</p>
        <h1 class="texto2">1</h1>
      </div>
    </div>

    <div class="col">
      <div class="titulo"></div>
      <img class="indicador-tempo" src="{{ url_for('static', filename='img/relogio2.png') }}" alt="Indicador de tempo" />
      <div class="tempo" id="tempo-preferencial">--</div>
      <div class="caixa" id="preferencial">
        <img class="img2" src="{{ url_for('static', filename='img/c.png') }}" alt="Imagem" />
      </div>
    </div>

    <div class="col">
      <div class="titulo"></div>
      <img class="indicador-tempo" src="{{ url_for('static', filename='img/relogio2.png') }}" alt="Indicador de tempo" />
      <div class="tempo" id="tempo-rapido">--</div>
      <div class="caixa" id="rapido">
        <img class="img2" src="{{ url_for('static', filename='img/r.png') }}" alt="Imagem" />
      </div>
    </div>

    <div class="col">
      <div class="titulo"></div>
      <img class="indicador-tempo" src="{{ url_for('static', filename='img/relogio2.png') }}" alt="Indicador de tempo" />
      <div class="tempo" id="tempo-autoatendimento">--</div>
      <div class="caixa" id="autoatendimento">
        <img class="img2" src="{{ url_for('static', filename='img/a.png') }}" alt="Imagem" />
      </div>
    </div>
  </div>

  <script>
    const temposSimulados = {
      preferencial: 0,
      rapido: 0,
      autoatendimento: 0,
    };

    function tempoAleatorio() {
      const valores = [0, 5, 10, 15, 20, 25, 30];
      return valores[Math.floor(Math.random() * valores.length)];
    }

    function atualizarImagemPorTempo(img, tempo) {
      if (tempo <= 5) {
        img.src = "{{ url_for('static', filename='img/rapido.png') }}";
      } else if (tempo >= 25) {
        img.src = "{{ url_for('static', filename='img/lento.png') }}";
      } else {
        img.src = "{{ url_for('static', filename='img/relogio2.png') }}";
      }
    }

    function simularTempoAleatorio() {
      ['preferencial', 'rapido', 'autoatendimento'].forEach((id) => {
        const novoTempo = tempoAleatorio();
        temposSimulados[id] = novoTempo;

        const caixa = document.getElementById(id);
        const tempoSpan = document.getElementById(`tempo-${id}`);
        const imgIndicador = caixa.parentElement.querySelector('.indicador-tempo');

        const displayTime = novoTempo === 0 ? '00:00' : `0:${novoTempo.toString().padStart(2, '0')}`;
        tempoSpan.textContent = displayTime;

        // Atualiza imagem conforme tempo
        atualizarImagemPorTempo(imgIndicador, novoTempo);

        // Altura inversamente proporcional
        const alturaMaxima = 400;
        const alturaMinima = 120;
        const altura = alturaMaxima - novoTempo * 8;
        caixa.style.height = `${Math.max(alturaMinima, altura)}px`;
      });
    }

    async function atualizarCaixaNormal() {
      try {
        const resp = await fetch('/count');
        const texto = await resp.text();

        const match = texto.match(/Tempo total: (\d+) minutos/);
        if (!match) return;

        const minutos = parseInt(match[1]);

        const caixa = document.getElementById('normal');
        const imgIndicador = caixa.parentElement.querySelector('.indicador-tempo');
        const tempoSpan = document.getElementById('tempo-normal');
        const tituloImg = caixa.parentElement.querySelector('.titulo');

        const displayTime = minutos === 0 ? '00:00' : `${Math.floor(minutos / 60)}:${(minutos % 60).toString().padStart(2, '0')}`;
        tempoSpan.textContent = displayTime;

        const alturaMaxima = 400;
        const alturaMinima = 120;
        const altura = alturaMaxima - minutos * 2;
        caixa.style.height = `${Math.max(alturaMinima, altura)}px`;

        atualizarImagemPorTempo(imgIndicador, minutos);

        if (minutos === 0) {
          tituloImg.src = "{{ url_for('static', filename='img/livre.png') }}";
        } else {
          tituloImg.src = "{{ url_for('static', filename='img/normal.png') }}";
        }
      } catch (err) {
        console.error('Erro ao atualizar caixa normal:', err);
      }
    }

    setInterval(simularTempoAleatorio, 3000); // simulados trocam a cada 1s
    setInterval(atualizarCaixaNormal, 10000); // normal atualiza a cada 5s
    atualizarCaixaNormal(); // inicial
  </script>
</body>

</html>
